<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 装箱引擎</title>
    <link href="https://cdn.jsdelivr.net/npm/quasar@2/dist/quasar.prod.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@quasar/extras/material-icons/material-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/tools/packing/css/style.css">
</head>
<body>
    <div id="q-app">
        <q-layout view="hHh lpR fFf" class="packing-layout">
            <q-header class="packing-header">
                <q-toolbar>
                    <q-btn dense flat round icon="menu" @click="drawerOpen = !drawerOpen" class="q-mr-sm gt-sm-hidden"></q-btn>
                    <q-icon name="inventory_2" size="28px" class="q-mr-sm text-primary"></q-icon>
                    <q-toolbar-title class="text-weight-bold">智能装箱引擎</q-toolbar-title>
                    <q-btn flat dense icon="center_focus_strong" label="居中" @click="resetView"></q-btn>
                    <q-btn flat dense icon="autorenew" :label="autoRotate ? '停止旋转' : '自动旋转'" @click="toggleAutoRotate"></q-btn>
                </q-toolbar>
            </q-header>

            <q-drawer v-model="drawerOpen" show-if-above bordered class="packing-drawer">
                <div class="drawer-content">
                    <div class="section-title">
                        <q-icon name="straighten" size="20px" class="text-primary"></q-icon>
                        <span>容器尺寸 (大箱子)</span>
                    </div>
                    <q-card flat bordered class="q-mb-md card-surface">
                        <q-card-section class="row q-col-gutter-sm">
                            <q-input v-model.number="bin.w" type="number" dense outlined label="宽 W" class="col-3"></q-input>
                            <q-input v-model.number="bin.h" type="number" dense outlined label="高 H" class="col-3"></q-input>
                            <q-input v-model.number="bin.d" type="number" dense outlined label="深 D" class="col-3"></q-input>
                            <q-select v-model="bin.unit" :options="units" dense outlined label="单位" class="col-3"></q-select>
                        </q-card-section>
                    </q-card>

                    <div class="section-title row items-center justify-between">
                        <div class="row items-center">
                            <q-icon name="widgets" size="20px" class="text-positive"></q-icon>
                            <span>货物清单</span>
                        </div>
                        <q-btn color="positive" icon="add" label="添加" dense rounded @click="addItem"></q-btn>
                    </div>

                    <div class="item-list">
                        <q-card v-for="(item, idx) in items" :key="item.id" flat bordered class="q-mb-md item-card">
                            <q-card-section class="row items-center q-col-gutter-sm">
                                <q-badge color="primary" class="q-mr-sm">#{{ idx + 1 }}</q-badge>
                                <q-input v-model="item.name" dense borderless placeholder="名称" class="col"></q-input>
                                <q-btn flat round dense icon="delete" color="negative" @click="removeItem(item.id)"></q-btn>
                            </q-card-section>
                            <q-separator></q-separator>
                            <q-card-section class="row q-col-gutter-sm">
                                <q-input v-model.number="item.w" type="number" dense outlined label="宽 W" class="col-3"></q-input>
                                <q-input v-model.number="item.h" type="number" dense outlined label="高 H" class="col-3"></q-input>
                                <q-input v-model.number="item.d" type="number" dense outlined label="深 D" class="col-3"></q-input>
                                <q-select v-model="item.unit" :options="units" dense outlined label="单位" class="col-3"></q-select>
                            </q-card-section>
                            <q-card-section class="row q-col-gutter-sm items-center">
                                <q-select
                                    v-model="item.color"
                                    :options="colorOptions"
                                    option-value="value"
                                    option-label="label"
                                    emit-value
                                    map-options
                                    dense
                                    outlined
                                    label="颜色"
                                    class="col-6"
                                >
                                    <template v-slot:option="scope">
                                        <q-item v-bind="scope.itemProps">
                                            <q-item-section avatar>
                                                <span class="color-dot" :style="{ background: scope.opt.value }"></span>
                                            </q-item-section>
                                            <q-item-section>{{ scope.opt.label }}</q-item-section>
                                        </q-item>
                                    </template>
                                    <template v-slot:selected-item="scope">
                                        <div class="row items-center no-wrap">
                                            <span class="color-dot q-mr-sm" :style="{ background: scope.opt.value }"></span>
                                            <span>{{ scope.opt.label }}</span>
                                        </div>
                                    </template>
                                </q-select>
                                <q-input v-model.number="item.qty" type="number" dense outlined label="数量" class="col-6"></q-input>
                            </q-card-section>
                        </q-card>
                    </div>

                    <q-card v-if="result.visible" flat bordered class="result-card">
                        <q-card-section class="text-center">
                            <div class="row justify-center q-gutter-sm q-mb-md">
                                <q-chip color="positive" text-color="white">装载率: {{ result.packRate }}%</q-chip>
                                <q-chip color="primary" text-color="white">剩余 {{ result.volumeLeft }} m³</q-chip>
                            </div>
                            <div class="result-stat">
                                <div class="text-caption text-grey">已装载总数</div>
                                <div class="text-h5 text-positive text-weight-bold">{{ result.packedCount }} / {{ result.total }}</div>
                            </div>
                            <div v-if="result.unpacked.length" class="unpacked-list q-mt-md">
                                <div class="text-negative text-caption q-mb-sm">未能装入货物:</div>
                                <q-list dense>
                                    <q-item v-for="item in result.unpacked" :key="item.name" class="unpacked-item">
                                        <q-item-section>{{ item.name.split('#')[0] }}</q-item-section>
                                        <q-item-section side>
                                            <q-badge color="negative">剩余 {{ item.left }} 件</q-badge>
                                        </q-item-section>
                                    </q-item>
                                </q-list>
                            </div>
                        </q-card-section>
                    </q-card>
                </div>
                <div class="drawer-footer">
                    <q-btn color="primary" class="full-width" size="lg" icon="rocket_launch" label="开始智能装箱计算" @click="runPacking"></q-btn>
                </div>
            </q-drawer>

            <q-page-container>
                <q-page class="canvas-page">
                    <div id="canvas-container"></div>
                    <div class="interaction-guide">
                        <div class="pc-guide">
                            <div class="guide-item"><q-icon name="mouse" size="16px" class="q-mr-xs"></q-icon>左键：旋转视角</div>
                            <div class="guide-item"><q-icon name="mouse" size="16px" class="q-mr-xs"></q-icon>右键：平移画面</div>
                            <div class="guide-item"><q-icon name="zoom_in" size="16px" class="q-mr-xs"></q-icon>滚轮：放大/缩小</div>
                        </div>
                        <div class="mobile-guide">
                            <div class="guide-item"><q-icon name="touch_app" size="16px" class="q-mr-xs"></q-icon>单指：滑动旋转</div>
                            <div class="guide-item"><q-icon name="open_with" size="16px" class="q-mr-xs"></q-icon>双指：平移/缩放</div>
                        </div>
                    </div>
                    <div v-if="!result.visible" class="empty-hint">
                        <q-icon name="inventory_2" size="64px" class="q-mb-sm"></q-icon>
                        <div>等待渲染计算数据...</div>
                    </div>
                </q-page>
            </q-page-container>
        </q-layout>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2/dist/quasar.umd.prod.js"></script>
    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }</script>
    <script type="module" src="/tools/packing/js/main.js"></script>
</body>
</html>
